# 10.1 File Upload & Validation

> *"A picture is worth a thousand words."*

à¹ƒà¸™à¸—à¸µà¹ˆà¸ªà¸¸à¸”à¹€à¸£à¸²à¸à¹‡à¸ˆà¸°à¹ƒà¸«à¹‰ User à¸­à¸±à¸›à¹‚à¸«à¸¥à¸”à¸£à¸¹à¸›à¹‚à¸›à¸£à¹„à¸Ÿà¸¥à¹Œà¹„à¸”à¹‰à¹à¸¥à¹‰à¸§! ðŸ“¸
à¹à¸•à¹ˆà¸à¸²à¸£à¸£à¸±à¸šà¹„à¸Ÿà¸¥à¹Œà¸ˆà¸²à¸ User à¹€à¸›à¹‡à¸™à¹€à¸£à¸·à¹ˆà¸­à¸‡à¸­à¸±à¸™à¸•à¸£à¸²à¸¢à¸™à¸°à¸„à¸£à¸±à¸š (à¸–à¹‰à¸²à¹€à¸‚à¸²à¸­à¸±à¸›à¹‚à¸«à¸¥à¸”à¹„à¸Ÿà¸¥à¹Œà¹„à¸§à¸£à¸±à¸ªà¸¡à¸²à¸¥à¹ˆà¸°?) à¸”à¸±à¸‡à¸™à¸±à¹‰à¸™ Module à¸™à¸µà¹‰à¹€à¸£à¸²à¸ˆà¸°à¹€à¸™à¹‰à¸™à¹€à¸£à¸·à¹ˆà¸­à¸‡ **Validation** à¹€à¸›à¹‡à¸™à¸žà¸´à¹€à¸¨à¸©

---

## ðŸ£ Analogy: Airport Security (à¸ˆà¸¸à¸”à¸•à¸£à¸§à¸ˆà¸ªà¸™à¸²à¸¡à¸šà¸´à¸™)

- **JSON Data**: à¹€à¸«à¸¡à¸·à¸­à¸™à¹€à¸”à¸´à¸™à¸•à¸±à¸§à¹€à¸›à¸¥à¹ˆà¸²à¸œà¹ˆà¸²à¸™à¹€à¸‚à¹‰à¸²à¹€à¸à¸— (à¸‡à¹ˆà¸²à¸¢ à¸•à¸£à¸§à¸ˆà¹à¸›à¹Šà¸šà¹€à¸”à¸µà¸¢à¸§)
- **File Upload**: à¹€à¸«à¸¡à¸·à¸­à¸™à¸¥à¸²à¸à¸à¸£à¸°à¹€à¸›à¹‹à¸²à¹€à¸”à¸´à¸™à¸—à¸²à¸‡à¹ƒà¸šà¹ƒà¸«à¸à¹ˆà¸¡à¸²
  - à¸•à¹‰à¸­à¸‡à¸œà¹ˆà¸²à¸™à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡à¸ªà¹à¸à¸™ (Virus Scan / File Type Check)
  - à¸•à¹‰à¸­à¸‡à¸Šà¸±à¹ˆà¸‡à¸™à¹‰à¸³à¸«à¸™à¸±à¸ (File Size Limit)
  - à¸•à¹‰à¸­à¸‡à¸•à¸´à¸”à¸›à¹‰à¸²à¸¢à¸Šà¸·à¹ˆà¸­ (Rename File)
  - à¹à¸¥à¹‰à¸§à¸„à¹ˆà¸­à¸¢à¸ªà¹ˆà¸‡à¹„à¸›à¹€à¸à¹‡à¸šà¹ƒà¸•à¹‰à¸—à¹‰à¸­à¸‡à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡ (Storage / Disk)

à¹ƒà¸™ Node.js, à¸žà¸£à¸°à¹€à¸­à¸à¸—à¸µà¹ˆà¸ˆà¸°à¸¡à¸²à¹€à¸›à¹‡à¸™ à¸£à¸›à¸ . à¹ƒà¸«à¹‰à¹€à¸£à¸²à¸„à¸·à¸­ Middleware à¸Šà¸·à¹ˆà¸­ **Multer** à¸„à¸£à¸±à¸š

---

## ðŸ› ï¸ Setup Multer

Multer à¹€à¸›à¹‡à¸™ middleware à¸ªà¸³à¸«à¸£à¸±à¸šà¸ˆà¸±à¸”à¸à¸²à¸£ `multipart/form-data` (à¸‹à¸¶à¹ˆà¸‡à¹€à¸›à¹‡à¸™ format à¸—à¸µà¹ˆà¹ƒà¸Šà¹‰à¸ªà¹ˆà¸‡à¹„à¸Ÿà¸¥à¹Œ)

```bash
npm install multer
```

### Basic Usage

```javascript
const multer = require('multer');

// à¸à¸³à¸«à¸™à¸”à¸—à¸µà¹ˆà¹€à¸à¹‡à¸šà¹„à¸Ÿà¸¥à¹Œ (Storage)
const storage = multer.diskStorage({
  destination: function (req, file, cb) {
    cb(null, 'uploads/') // à¹€à¸à¹‡à¸šà¹ƒà¸™à¹‚à¸Ÿà¸¥à¹€à¸”à¸­à¸£à¹Œ uploads
  },
  filename: function (req, file, cb) {
    // à¸•à¸±à¹‰à¸‡à¸Šà¸·à¹ˆà¸­à¹„à¸Ÿà¸¥à¹Œà¹ƒà¸«à¸¡à¹ˆà¹ƒà¸«à¹‰à¹„à¸¡à¹ˆà¸‹à¹‰à¸³à¸à¸±à¸™ (à¹€à¸Šà¹ˆà¸™ timestamp-à¸Šà¸·à¹ˆà¸­à¹€à¸”à¸´à¸¡)
    const uniqueSuffix = Date.now() + '-' + Math.round(Math.random() * 1E9);
    cb(null, uniqueSuffix + '-' + file.originalname)
  }
});

const upload = multer({ storage: storage });

// à¹ƒà¸Šà¹‰ upload.single('fieldname') à¹ƒà¸™ Route
app.post('/profile', upload.single('avatar'), (req, res) => {
  // req.file à¸„à¸·à¸­à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹„à¸Ÿà¸¥à¹Œà¸—à¸µà¹ˆà¸­à¸±à¸›à¹‚à¸«à¸¥à¸”
  // req.body à¸„à¸·à¸­à¸‚à¹‰à¸­à¸¡à¸¹à¸¥ text à¸­à¸·à¹ˆà¸™à¹†
  console.log(req.file);
  res.send('File uploaded!');
});
```

---

## ðŸ›¡ï¸ Validation (à¸à¸²à¸£à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¹„à¸Ÿà¸¥à¹Œ)

à¸ªà¸³à¸„à¸±à¸à¸¡à¸²à¸! à¹€à¸£à¸²à¸•à¹‰à¸­à¸‡à¸à¸£à¸­à¸‡à¹„à¸Ÿà¸¥à¹Œà¸—à¸µà¹ˆà¹„à¸¡à¹ˆà¹ƒà¸Šà¹ˆà¸£à¸¹à¸›à¸ à¸²à¸žà¸­à¸­à¸ à¹à¸¥à¸°à¸ˆà¸³à¸à¸±à¸”à¸‚à¸™à¸²à¸”à¹„à¸Ÿà¸¥à¹Œ

```javascript
const upload = multer({ 
  storage: storage,
  limits: {
    fileSize: 1024 * 1024 * 5 // à¸ˆà¸³à¸à¸±à¸” 5 MB
  },
  fileFilter: (req, file, cb) => {
    // à¹€à¸Šà¹‡à¸„ Mime Type (à¹€à¸Šà¹ˆà¸™ 'image/jpeg', 'image/png')
    if (file.mimetype.startsWith('image/')) {
      cb(null, true); // à¸œà¹ˆà¸²à¸™
    } else {
      cb(new Error('Only images are allowed!'), false); // à¹„à¸¡à¹ˆà¸œà¹ˆà¸²à¸™
    }
  }
});
```

---

## ðŸš¦ Input Validation with `express-validator`

à¸™à¸­à¸à¸ˆà¸²à¸à¹„à¸Ÿà¸¥à¹Œà¹à¸¥à¹‰à¸§ à¸‚à¹‰à¸­à¸¡à¸¹à¸¥ Text à¸—à¸µà¹ˆà¸ªà¹ˆà¸‡à¸¡à¸²à¸à¹‡à¸•à¹‰à¸­à¸‡à¸•à¸£à¸§à¸ˆà¸”à¹‰à¸§à¸¢
à¹€à¸Šà¹ˆà¸™ Email à¸•à¹‰à¸­à¸‡à¸¡à¸µ @, Password à¸•à¹‰à¸­à¸‡à¸¢à¸²à¸§ 6 à¸•à¸±à¸§à¸­à¸±à¸à¸©à¸£

```bash
npm install express-validator
```

```javascript
const { body, validationResult } = require('express-validator');

app.post('/register', [
  // à¸à¸Žà¸à¸²à¸£à¸•à¸£à¸§à¸ˆ
  body('email').isEmail().withMessage('Email à¹„à¸¡à¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡'),
  body('password').isLength({ min: 6 }).withMessage('à¸£à¸«à¸±à¸ªà¸œà¹ˆà¸²à¸™à¸ªà¸±à¹‰à¸™à¹„à¸›'),
], (req, res) => {
    
  // à¸”à¸¹à¸œà¸¥à¸¥à¸±à¸žà¸˜à¹Œ
  const errors = validationResult(req);
  if (!errors.isEmpty()) {
    return res.status(400).json({ errors: errors.array() });
  }

  res.send("à¸œà¹ˆà¸²à¸™à¸à¸²à¸£à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š âœ…");
});
```

---

## ðŸ“š Glossary

| à¸„à¸³à¸¨à¸±à¸žà¸—à¹Œ | à¸„à¸§à¸²à¸¡à¸«à¸¡à¸²à¸¢ |
|:--------|:---------|
| **Multipart/form-data** | Content-Type à¸‚à¸­à¸‡ HTTP à¸ªà¸³à¸«à¸£à¸±à¸šà¸ªà¹ˆà¸‡à¹„à¸Ÿà¸¥à¹Œ (Binary) à¸œà¸ªà¸¡à¸à¸±à¸š Text |
| **Multer** | Node.js Middleware à¸¢à¸­à¸”à¸™à¸´à¸¢à¸¡à¸ªà¸³à¸«à¸£à¸±à¸šà¸ˆà¸±à¸”à¸à¸²à¸£ File Upload |
| **MIME Type** | à¸£à¸«à¸±à¸ªà¸šà¸­à¸à¸›à¸£à¸°à¹€à¸ à¸—à¹„à¸Ÿà¸¥à¹Œ (à¹€à¸Šà¹ˆà¸™ `image/jpeg`, `application/pdf`) à¸ªà¸³à¸„à¸±à¸à¸à¸§à¹ˆà¸²à¸™à¸²à¸¡à¸ªà¸à¸¸à¸¥à¹„à¸Ÿà¸¥à¹Œ |
| **Stream** | à¸à¸²à¸£à¸ªà¹ˆà¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹à¸šà¸šà¹„à¸«à¸¥à¸¡à¸²à¹€à¸£à¸·à¹ˆà¸­à¸¢à¹† (Node.js à¸ˆà¸±à¸”à¸à¸²à¸£à¹„à¸Ÿà¸¥à¹Œà¹à¸šà¸š Stream à¹€à¸žà¸·à¹ˆà¸­à¸›à¸£à¸°à¸«à¸¢à¸±à¸” Ram) |
| **Sanitization** | à¸à¸²à¸£à¸—à¸³à¸„à¸§à¸²à¸¡à¸ªà¸°à¸­à¸²à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥ input (à¹€à¸Šà¹ˆà¸™ à¸¥à¸š tag html à¸­à¸­à¸ à¹€à¸žà¸·à¹ˆà¸­à¸à¸±à¸™ XSS) |
| **Validation** | à¸à¸²à¸£à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸§à¹ˆà¸²à¸‚à¹‰à¸­à¸¡à¸¹à¸¥ input à¸–à¸¹à¸à¸•à¹‰à¸­à¸‡à¸•à¸²à¸¡à¸à¸Žà¹€à¸à¸“à¸‘à¹Œà¸«à¸£à¸·à¸­à¹„à¸¡à¹ˆ |

---

> ðŸ‘‰ **à¹„à¸›à¸•à¹ˆà¸­: [Project: Image Upload API](/node/10-project-upload-api)**
