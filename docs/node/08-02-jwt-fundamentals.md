# Module 8.2: JWT Fundamentals ðŸŽ«

> *"Stateless but Secure."*

à¹ƒà¸™à¸¢à¸¸à¸„ Web à¸ªà¸¡à¸±à¸¢à¸à¹ˆà¸­à¸™ à¹€à¸£à¸²à¹ƒà¸Šà¹‰ **Session/Cookie** à¹ƒà¸™à¸à¸²à¸£à¸ˆà¸³à¸§à¹ˆà¸² User à¸¥à¹‡à¸­à¸à¸­à¸´à¸™à¸«à¸£à¸·à¸­à¸¢à¸±à¸‡
à¹à¸•à¹ˆà¹ƒà¸™à¸¢à¸¸à¸„ Modern App (React, Mobile App, Microservices) **Session** à¹€à¸£à¸´à¹ˆà¸¡à¹„à¸¡à¹ˆà¸•à¸­à¸šà¹‚à¸ˆà¸—à¸¢à¹Œà¹€à¸žà¸£à¸²à¸°:
1.  **Scalability**: à¸–à¹‰à¸²à¸¡à¸µ Server à¸«à¸¥à¸²à¸¢à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡ à¸•à¹‰à¸­à¸‡à¹à¸Šà¸£à¹Œ Session à¸à¸±à¸™ (à¸§à¸¸à¹ˆà¸™à¸§à¸²à¸¢)
2.  **Cross-Domain**: Frontend à¸­à¸¢à¸¹à¹ˆà¸­à¸µà¸à¹‚à¸”à¹€à¸¡à¸™ Backend à¸­à¸¢à¸¹à¹ˆà¸­à¸µà¸à¹‚à¸”à¹€à¸¡à¸™ Cookie à¸ªà¹ˆà¸‡à¸‚à¹‰à¸²à¸¡à¸¢à¸²à¸

à¸žà¸£à¸°à¹€à¸­à¸à¸‚à¸­à¸‡à¹€à¸£à¸²à¸„à¸·à¸­ **JSON Web Token (JWT)** à¸„à¸£à¸±à¸š ðŸŽ«
à¸¡à¸±à¸™à¸„à¸·à¸­ "à¸šà¸±à¸•à¸£à¸œà¹ˆà¸²à¸™à¸—à¸²à¸‡" à¸—à¸µà¹ˆ User à¸žà¸à¸•à¸´à¸”à¸•à¸±à¸§à¹„à¸§à¹‰ à¸¢à¸·à¹ˆà¸™à¹ƒà¸«à¹‰ Server à¸”à¸¹à¸—à¸¸à¸à¸„à¸£à¸±à¹‰à¸‡à¸—à¸µà¹ˆà¸‚à¸­à¸‚à¹‰à¸­à¸¡à¸¹à¸¥


## ðŸ£ Analogy: Wristband at a Concert (à¸ªà¸²à¸¢à¸£à¸±à¸”à¸‚à¹‰à¸­à¸¡à¸·à¸­à¸„à¸­à¸™à¹€à¸ªà¸´à¸£à¹Œà¸•)

- **Login** = à¹€à¸”à¸´à¸™à¹„à¸›à¸—à¸µà¹ˆà¸ˆà¸¸à¸”à¸¥à¸‡à¸—à¸°à¹€à¸šà¸µà¸¢à¸™ (Authentication)
    - à¸„à¸¸à¸“à¸¢à¸·à¹ˆà¸™à¸šà¸±à¸•à¸£à¸›à¸£à¸°à¸Šà¸²à¸Šà¸™ (Username/Password)
    - à¹€à¸ˆà¹‰à¸²à¸«à¸™à¹‰à¸²à¸—à¸µà¹ˆà¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š -> à¸–à¹‰à¸²à¸–à¸¹à¸ -> **à¹ƒà¸ªà¹ˆà¸ªà¸²à¸¢à¸£à¸±à¸”à¸‚à¹‰à¸­à¸¡à¸·à¸­à¹ƒà¸«à¹‰ (JWT)**

- **Access** = à¹€à¸”à¸´à¸™à¹€à¸‚à¹‰à¸²à¹‚à¸‹à¸™ VIP (Authorization)
    - à¸„à¸¸à¸“à¹‚à¸Šà¸§à¹Œà¸ªà¸²à¸¢à¸£à¸±à¸”à¸‚à¹‰à¸­à¸¡à¸·à¸­à¹ƒà¸«à¹‰à¸žà¸™à¸±à¸à¸‡à¸²à¸™à¸”à¸¹
    - à¸žà¸™à¸±à¸à¸‡à¸²à¸™à¹à¸„à¹ˆà¸¡à¸­à¸‡ (Verify Signature) -> **à¸£à¸¹à¹‰à¸—à¸±à¸™à¸—à¸µà¸§à¹ˆà¸²à¸šà¸±à¸•à¸£à¸ˆà¸£à¸´à¸‡à¸«à¸£à¸·à¸­à¸›à¸¥à¸­à¸¡** à¹‚à¸”à¸¢à¹„à¸¡à¹ˆà¸•à¹‰à¸­à¸‡à¸§à¸´à¹ˆà¸‡à¸à¸¥à¸±à¸šà¹„à¸›à¸–à¸²à¸¡à¸ˆà¸¸à¸”à¸¥à¸‡à¸—à¸°à¹€à¸šà¸µà¸¢à¸™ (Stateless)
    - à¸–à¹‰à¸²à¸ªà¸²à¸¢à¸£à¸±à¸”à¸‚à¹‰à¸­à¸¡à¸·à¸­à¸£à¸°à¸šà¸¸à¸§à¹ˆà¸² "VIP" -> à¹€à¸‚à¹‰à¸²à¹„à¸”à¹‰
    - à¸–à¹‰à¸²à¸ªà¸²à¸¢à¸£à¸±à¸”à¸‚à¹‰à¸­à¸¡à¸·à¸­à¸‚à¸²à¸”/à¸«à¸¡à¸”à¸­à¸²à¸¢à¸¸ -> à¹€à¸‚à¹‰à¸²à¹„à¸¡à¹ˆà¹„à¸”à¹‰


## ðŸ§© Structure of JWT

JWT à¹€à¸›à¹‡à¸™ string à¸¢à¸²à¸§à¹† à¸—à¸µà¹ˆà¸¡à¸µà¸ˆà¸¸à¸” `.` à¸„à¸±à¹ˆà¸™ 3 à¸ªà¹ˆà¸§à¸™: `aaaaa.bbbbb.ccccc`

1.  **Header**: à¸šà¸­à¸à¸§à¹ˆà¸²à¹€à¸›à¹‡à¸™ JWT à¹à¸¥à¸°à¹ƒà¸Šà¹‰à¸­à¸±à¸¥à¸à¸­à¸£à¸´à¸—à¸¶à¸¡à¸­à¸°à¹„à¸£ (à¹€à¸Šà¹ˆà¸™ HS256)
2.  **Payload**: "à¹„à¸ªà¹‰à¹ƒà¸™" à¸—à¸µà¹ˆà¹€à¸£à¸²à¸­à¸¢à¸²à¸à¹€à¸à¹‡à¸š (à¹€à¸Šà¹ˆà¸™ User ID, Role, Expire) **à¸ªà¹ˆà¸§à¸™à¸™à¸µà¹‰à¹ƒà¸„à¸£à¹† à¸à¹‡à¸­à¹ˆà¸²à¸™à¹„à¸”à¹‰ à¸«à¹‰à¸²à¸¡à¹€à¸à¹‡à¸š Password!**
3.  **Signature**: à¸¥à¸²à¸¢à¹€à¸‹à¹‡à¸™à¸”à¸´à¸ˆà¸´à¸—à¸±à¸¥ (à¹€à¸­à¸² Header + Payload + **Secret Key** à¸¡à¸²à¸œà¸ªà¸¡à¸à¸±à¸™) **à¸ªà¹ˆà¸§à¸™à¸™à¸µà¹‰à¸„à¸·à¸­à¸„à¸§à¸²à¸¡à¸¥à¸±à¸š** à¸—à¸µà¹ˆà¸—à¸³à¹ƒà¸«à¹‰à¸›à¸¥à¸­à¸¡à¹à¸›à¸¥à¸‡à¹„à¸¡à¹ˆà¹„à¸”à¹‰

> ðŸ’¡ **Secret Key**: à¸à¸¸à¸à¹à¸ˆà¸¥à¸±à¸šà¸—à¸µà¹ˆà¸¡à¸µà¹à¸„à¹ˆà¸à¸±à¹ˆà¸‡ Server à¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™à¸—à¸µà¹ˆà¸£à¸¹à¹‰ (à¹€à¸à¹‡à¸šà¹ƒà¸™ `.env`) à¸–à¹‰à¸²à¸«à¸¥à¸¸à¸” -> à¸ˆà¸šà¹€à¸«à¹ˆ!


## ðŸ› ï¸ Implementation: Generating Token

```bash
npm install jsonwebtoken
```

à¹€à¸£à¸²à¸ˆà¸°à¹ƒà¸Šà¹‰à¸‡à¸²à¸™à¹ƒà¸™ Auth Controller à¸•à¸­à¸™ User Login à¸ªà¸³à¹€à¸£à¹‡à¸ˆ:

```javascript
/* controller/authController.js */
const jwt = require('jsonwebtoken');

const login = async (req, res) => {
  // ... (à¸ªà¸¡à¸¡à¸•à¸´à¸§à¹ˆà¸²à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š password à¸œà¹ˆà¸²à¸™à¹à¸¥à¹‰à¸§) ...
  
  // 1. à¹€à¸•à¸£à¸µà¸¢à¸¡ Payload (à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸—à¸µà¹ˆà¸ˆà¸°à¸à¸±à¸‡à¹ƒà¸™ Token)
  const payload = {
    id: user._id,
    role: user.role, // à¹ƒà¸ªà¹ˆ role à¹„à¸›à¸”à¹‰à¸§à¸¢à¸ˆà¸°à¹„à¸”à¹‰à¹€à¸Šà¹‡à¸„à¸ªà¸´à¸—à¸˜à¸´à¹Œà¸‡à¹ˆà¸²à¸¢à¹†
    username: user.username
  };

  // 2. Sign Token (à¹€à¸‹à¹‡à¸™à¸Šà¸·à¹ˆà¸­à¸à¸³à¸à¸±à¸š)
  const token = jwt.sign(
    payload,
    process.env.JWT_SECRET, // à¸à¸¸à¸à¹à¸ˆà¸¥à¸±à¸š (à¸«à¹‰à¸²à¸¡à¸šà¸­à¸à¹ƒà¸„à¸£ à¸•à¹‰à¸­à¸‡à¹€à¸à¹‡à¸šà¹ƒà¸™ .env)
    { expiresIn: '1h' }     // à¸­à¸²à¸¢à¸¸ 1 à¸Šà¸±à¹ˆà¸§à¹‚à¸¡à¸‡ (à¸«à¸¡à¸”à¸­à¸²à¸¢à¸¸à¹à¸¥à¹‰à¸§à¸•à¹‰à¸­à¸‡ login à¹ƒà¸«à¸¡à¹ˆ)
  );

  // 3. à¸ªà¹ˆà¸‡à¸à¸¥à¸±à¸šà¹„à¸›à¹ƒà¸«à¹‰ Frontend
  res.json({ 
    message: "Login successful",
    token: token 
  }); 
};
```

*(à¸ªà¹ˆà¸§à¸™à¸à¸²à¸£à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š Token à¸«à¸£à¸·à¸­ Validate à¹€à¸£à¸²à¸ˆà¸°à¸¢à¸à¹„à¸›à¸žà¸¹à¸”à¸–à¸¶à¸‡à¹ƒà¸™à¸šà¸—à¸–à¸±à¸”à¹„à¸›à¹€à¸£à¸·à¹ˆà¸­à¸‡ Middleware à¸„à¸£à¸±à¸š)*


## â³ Concept: Refresh Token

**à¸›à¸±à¸à¸«à¸²**: Access Token à¸¡à¸µà¸­à¸²à¸¢à¸¸à¸™à¹‰à¸­à¸¢ (à¹€à¸Šà¹ˆà¸™ 15 à¸™à¸²à¸—à¸µ) à¹€à¸žà¸·à¹ˆà¸­à¸„à¸§à¸²à¸¡à¸›à¸¥à¸­à¸”à¸ à¸±à¸¢... à¹à¸•à¹ˆà¹„à¸¡à¹ˆà¸­à¸¢à¸²à¸à¹ƒà¸«à¹‰ User à¸¥à¹‡à¸­à¸à¸­à¸´à¸™à¹ƒà¸«à¸¡à¹ˆà¸šà¹ˆà¸­à¸¢à¹†
**à¸—à¸²à¸‡à¹à¸à¹‰**: à¹ƒà¸Šà¹‰à¸£à¸°à¸šà¸š **Refresh Token**

1.  **Login**: à¹„à¸”à¹‰à¸£à¸±à¸š 2 tokens
    - `accessToken` (à¸­à¸²à¸¢à¸¸à¸ªà¸±à¹‰à¸™ 15 à¸™à¸²à¸—à¸µ): à¹ƒà¸Šà¹‰à¸¢à¸·à¹ˆà¸™à¹€à¸‚à¹‰à¸²à¸‡à¸²à¸™
    - `refreshToken` (à¸­à¸²à¸¢à¸¸à¸¢à¸²à¸§ 7 à¸§à¸±à¸™): à¹€à¸à¹‡à¸šà¹„à¸§à¹‰à¹ƒà¸™à¹€à¸‹à¸Ÿ, à¹ƒà¸Šà¹‰à¹à¸¥à¸ accessToken à¹ƒà¸šà¹ƒà¸«à¸¡à¹ˆ
2.  **Access**: à¹ƒà¸Šà¹‰ accessToken à¸ˆà¸™à¸«à¸¡à¸”à¸­à¸²à¸¢à¸¸ -> Server à¸•à¸­à¸š 401
3.  **Renew**: Frontend à¸ªà¹ˆà¸‡ refreshToken à¹„à¸›à¸‚à¸­à¹ƒà¸šà¹ƒà¸«à¸¡à¹ˆ -> à¹„à¸”à¹‰ accessToken à¹ƒà¸«à¸¡à¹ˆ
4.  **Logout**: à¸¥à¸š refreshToken à¸—à¸´à¹‰à¸‡à¸ˆà¸²à¸ Database (à¸—à¸³à¹ƒà¸«à¹‰à¹à¸¥à¸à¹ƒà¸«à¸¡à¹ˆà¹„à¸¡à¹ˆà¹„à¸”à¹‰à¹à¸¥à¹‰à¸§)

> *à¹ƒà¸™à¸„à¸­à¸£à¹Œà¸ªà¹€à¸šà¸·à¹‰à¸­à¸‡à¸•à¹‰à¸™à¹€à¸£à¸²à¸ˆà¸°à¹ƒà¸Šà¹‰à¹à¸„à¹ˆ Access Token à¸­à¸²à¸¢à¸¸à¸›à¸²à¸™à¸à¸¥à¸²à¸‡ (à¹€à¸Šà¹ˆà¸™ 1 à¸§à¸±à¸™) à¹€à¸žà¸·à¹ˆà¸­à¸„à¸§à¸²à¸¡à¸‡à¹ˆà¸²à¸¢à¸„à¸£à¸±à¸š*


## ðŸ¥Š Challenges

### Level 1: Payload Security
(à¸‚à¹‰à¸­à¸™à¸µà¹‰à¸—à¸”à¸ªà¸­à¸šà¸„à¸§à¸²à¸¡à¸£à¸¹à¹‰) à¸–à¹‰à¸²à¹€à¸£à¸²à¹„à¸”à¹‰ JWT à¸¡à¸² à¹€à¸£à¸²à¸ªà¸²à¸¡à¸²à¸£à¸–à¸­à¹ˆà¸²à¸™à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸‚à¹‰à¸²à¸‡à¹ƒà¸™ (Payload) à¹‚à¸”à¸¢à¹„à¸¡à¹ˆà¸£à¸¹à¹‰ Secret Key à¹„à¸”à¹‰à¸«à¸£à¸·à¸­à¹„à¸¡à¹ˆ?
à¹à¸¥à¸°à¸—à¸³à¹„à¸¡à¹€à¸£à¸²à¸–à¸¶à¸‡ **à¸«à¹‰à¸²à¸¡à¹€à¸à¹‡à¸š Password à¹ƒà¸™ Payload**?

::: details âœ¨ à¹€à¸‰à¸¥à¸¢
**à¹„à¸”à¹‰à¸„à¸£à¸±à¸š!**
Payload à¹€à¸›à¹‡à¸™à¹à¸„à¹ˆ Base64Encode à¹ƒà¸„à¸£à¹† à¸à¹‡à¸–à¸­à¸”à¸¡à¸²à¸”à¸¹à¹„à¸”à¹‰ (à¸¥à¸­à¸‡à¹€à¸­à¸² Token à¹„à¸›à¸§à¸²à¸‡à¹ƒà¸™à¹€à¸§à¹‡à¸š jwt.io à¸”à¸¹à¸ªà¸´)
à¸”à¸±à¸‡à¸™à¸±à¹‰à¸™ **à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸„à¸§à¸²à¸¡à¸¥à¸±à¸š** (Password, à¸šà¸±à¸•à¸£à¹€à¸„à¸£à¸”à¸´à¸•) **à¸«à¹‰à¸²à¸¡** à¹ƒà¸ªà¹ˆà¹ƒà¸™ Payload à¹€à¸”à¹‡à¸”à¸‚à¸²à¸”
Secret Key à¸¡à¸µà¹„à¸§à¹‰à¹€à¸žà¸·à¹ˆà¸­à¸à¸±à¸™à¸à¸²à¸£ "à¹à¸à¹‰à¹„à¸‚" à¸‚à¹‰à¸­à¸¡à¸¹à¸¥ à¹„à¸¡à¹ˆà¹„à¸”à¹‰à¸à¸±à¸™à¸à¸²à¸£ "à¸­à¹ˆà¸²à¸™" à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸„à¸£à¸±à¸š
:::


## ðŸ“š Glossary

| à¸„à¸³à¸¨à¸±à¸žà¸—à¹Œ | à¸„à¸§à¸²à¸¡à¸«à¸¡à¸²à¸¢ |
|:--------|:---------|
| **JWT** | JSON Web Token à¸¡à¸²à¸•à¸£à¸à¸²à¸™ Token à¸ªà¸³à¸«à¸£à¸±à¸šà¸ªà¹ˆà¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸­à¸¢à¹ˆà¸²à¸‡à¸›à¸¥à¸­à¸”à¸ à¸±à¸¢ |
| **Stateless** | à¸£à¸°à¸šà¸šà¸—à¸µà¹ˆà¹„à¸¡à¹ˆà¸•à¹‰à¸­à¸‡à¸ˆà¸³à¸­à¸°à¹„à¸£à¸—à¸µà¹ˆ Server (JWT à¹€à¸à¹‡à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹ƒà¸™à¸•à¸±à¸§à¹€à¸­à¸‡ Server à¹à¸„à¹ˆà¹€à¸Šà¹‡à¸à¸¥à¸²à¸¢à¹€à¸‹à¹‡à¸™) |
| **Payload** | à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸—à¸µà¹ˆà¹€à¸£à¸²à¸à¸²à¸à¹„à¸§à¹‰à¹ƒà¸™ Token (à¹€à¸Šà¹ˆà¸™ ID, Name, Role) |
| **Signature** | à¸ªà¹ˆà¸§à¸™à¸—à¹‰à¸²à¸¢à¸‚à¸­à¸‡ Token à¸—à¸µà¹ˆà¹€à¸‚à¹‰à¸²à¸£à¸«à¸±à¸ªà¹„à¸§à¹‰à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸„à¸§à¸²à¸¡à¸–à¸¹à¸à¸•à¹‰à¸­à¸‡ (à¸›à¹‰à¸­à¸‡à¸à¸±à¸™à¸à¸²à¸£à¸›à¸¥à¸­à¸¡à¹à¸›à¸¥à¸‡) |


## ðŸ”— References

- [jwt.io](https://jwt.io/) - à¹€à¸§à¹‡à¸šà¸ªà¸³à¸«à¸£à¸±à¸š Debug à¹à¸¥à¸°à¹€à¸£à¸µà¸¢à¸™à¸£à¸¹à¹‰à¹‚à¸„à¸£à¸‡à¸ªà¸£à¹‰à¸²à¸‡ JWT (à¸”à¸µà¸¡à¸²à¸!)
- [npm jsonwebtoken](https://www.npmjs.com/package/jsonwebtoken) - à¹€à¸­à¸à¸ªà¸²à¸£à¸à¸²à¸£à¹ƒà¸Šà¹‰à¹„à¸¥à¸šà¸£à¸²à¸£à¸µ
- [RFC 7519](https://tools.ietf.org/html/rfc7519) - à¸¡à¸²à¸•à¸£à¸à¸²à¸™ JWT à¸­à¸¢à¹ˆà¸²à¸‡à¹€à¸›à¹‡à¸™à¸—à¸²à¸‡à¸à¸²à¸£


> ðŸ‘‰ **à¹„à¸›à¸•à¹ˆà¸­: [Authentication Middleware](/node/08-03-auth-middleware)**
