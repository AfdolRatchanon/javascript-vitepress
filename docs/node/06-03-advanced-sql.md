# Module 6.3: Advanced SQL & Optimization üöÄ

> **"SQL is easy to learn, but hard to master."**

‡πÉ‡∏ô‡∏ö‡∏ó‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏£‡∏≤‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô `SELECT * FROM users` ‡∏Å‡∏±‡∏ô‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß
‡πÅ‡∏ï‡πà‡πÉ‡∏ô‡πÇ‡∏•‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏£‡∏¥‡∏á... ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏°‡∏µ‡πÅ‡∏Ñ‡πà 10 ‡πÅ‡∏ñ‡∏ß ‡πÅ‡∏ï‡πà‡∏°‡∏µ‡πÄ‡∏õ‡πá‡∏ô **‡∏•‡πâ‡∏≤‡∏ô‡πÅ‡∏ñ‡∏ß (Millions of records)**!
‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô Query ‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏Ñ‡∏¥‡∏î‡∏≠‡∏≤‡∏à‡∏ó‡∏≥‡πÉ‡∏´‡πâ Server **"‡∏£‡∏∞‡πÄ‡∏ö‡∏¥‡∏î"** ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ß‡πá‡∏ö‡∏´‡∏°‡∏∏‡∏ô‡∏ï‡∏¥‡πâ‡∏ß‡πÑ‡∏î‡πâ‡∏á‡πà‡∏≤‡∏¢‡πÜ ü§Ø

‡∏ö‡∏ó‡∏ô‡∏µ‡πâ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡∏°‡∏≤‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î Skill SQL ‡∏™‡∏π‡πà‡∏£‡∏∞‡∏î‡∏±‡∏ö **Senior** ‡∏Å‡∏±‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö
‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡∏Ñ‡∏∏‡∏¢‡∏Å‡∏±‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á Performance, ACID, Transactions ‡πÅ‡∏•‡∏∞‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô Query ‡∏ó‡∏µ‡πà‡∏ã‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô

---

## üèéÔ∏è 1. Indexing: The Speed Demon

### What is an Index?
‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö Database ‡πÄ‡∏õ‡πá‡∏ô "‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠" üìö
*   **Table**: ‡∏Ñ‡∏∑‡∏≠‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÉ‡∏ô‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠ (‡∏û‡∏±‡∏ô‡∏´‡∏ô‡πâ‡∏≤)
*   **Index**: ‡∏Ñ‡∏∑‡∏≠ "‡∏™‡∏≤‡∏£‡∏ö‡∏±‡∏ç" ‡∏ó‡πâ‡∏≤‡∏¢‡πÄ‡∏•‡πà‡∏° (Index)

‡∏ñ‡πâ‡∏≤‡∏ú‡∏°‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì‡∏´‡∏≤‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ "Zebra" ‡πÉ‡∏ô‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠:
*   **No Index (Full Table Scan)**: ‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏≤‡∏ó‡∏µ‡∏•‡∏∞‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡∏´‡∏ô‡πâ‡∏≤ 1... ‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏∞‡πÄ‡∏à‡∏≠ (‡∏ä‡πâ‡∏≤‡∏°‡∏≤‡∏Å O(n))
*   **With Index**: ‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏õ‡∏¥‡∏î‡∏™‡∏≤‡∏£‡∏ö‡∏±‡∏ç‡∏î‡∏π‡∏´‡∏°‡∏ß‡∏î Z -> ‡πÄ‡∏à‡∏≠‡πÄ‡∏•‡∏Ç‡∏´‡∏ô‡πâ‡∏≤ -> ‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡πÄ‡∏•‡∏¢ (‡πÄ‡∏£‡πá‡∏ß‡∏°‡∏≤‡∏Å O(log n))

### How to Create Index
```sql
-- ‡∏™‡∏£‡πâ‡∏≤‡∏á Index ‡∏ó‡∏µ‡πà column `email` ‡∏Ç‡∏≠‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á `users`
CREATE INDEX idx_users_email ON users(email);

-- Composite Index (Index 2 ‡∏ï‡∏±‡∏ß‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô)
-- ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏Å‡∏±‡∏ö query ‡∏ó‡∏µ‡πà‡∏°‡∏µ WHERE ... AND ...
CREATE INDEX idx_users_name_age ON users(name, age);
```

### When NOT to Index? ‚ö†Ô∏è
Index ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏Ç‡∏≠‡∏á‡∏ü‡∏£‡∏µ!
1.  **‡πÄ‡∏õ‡∏•‡∏∑‡∏≠‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà Disk**: ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≤‡∏£‡∏ö‡∏±‡∏ç‡πÅ‡∏¢‡∏Å‡∏ï‡πà‡∏≤‡∏á‡∏´‡∏≤‡∏Å
2.  **INSERT/UPDATE ‡∏ä‡πâ‡∏≤‡∏•‡∏á**: ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Database ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏ô‡∏±‡πà‡∏á‡πÅ‡∏Å‡πâ‡∏™‡∏≤‡∏£‡∏ö‡∏±‡∏ç‡∏î‡πâ‡∏ß‡∏¢!

**‡∏Å‡∏é‡πÄ‡∏´‡∏•‡πá‡∏Å:** ‡πÉ‡∏™‡πà Index ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Colum ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÉ‡∏ô `WHERE`, `JOIN`, `ORDER BY` ‡∏ö‡πà‡∏≠‡∏¢‡πÜ ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô!

---

## üîÑ 2. Advanced JOINs

`INNER JOIN` ‡∏Ñ‡∏∑‡∏≠‡∏ó‡πà‡∏≤‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ô‡∏ö‡πà‡∏≠‡∏¢‡∏™‡∏∏‡∏î (‡πÄ‡∏≠‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô‡∏ó‡∏±‡πâ‡∏á 2 ‡∏ï‡∏≤‡∏£‡∏≤‡∏á)
‡πÅ‡∏ï‡πà‡πÇ‡∏•‡∏Å‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡∏°‡∏µ JOIN ‡πÅ‡∏ö‡∏ö‡∏≠‡∏∑‡πà‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏£‡∏á‡∏û‡∏•‡∏±‡∏á‡∏≠‡∏µ‡∏Å‡∏°‡∏≤‡∏Å!

### 2.1 LEFT JOIN (‡πÄ‡∏≠‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡πâ‡∏á‡∏ï‡πâ‡∏ô‡∏Ñ‡∏£‡∏ö)
‡∏≠‡∏¢‡∏≤‡∏Å‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤ "User ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô ‡∏ã‡∏∑‡πâ‡∏≠‡∏≠‡∏∞‡πÑ‡∏£‡∏ö‡πâ‡∏≤‡∏á? (‡∏£‡∏ß‡∏°‡∏ñ‡∏∂‡∏á‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà *‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡∏ã‡∏∑‡πâ‡∏≠* ‡∏î‡πâ‡∏ß‡∏¢)"
```sql
SELECT users.name, orders.id
FROM users
LEFT JOIN orders ON users.id = orders.user_id;

-- Result:
-- Somchai | 101
-- Somsak  | NULL  <-- Somsak ‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡∏ã‡∏∑‡πâ‡∏≠ ‡πÅ‡∏ï‡πà‡∏Å‡πá‡πÇ‡∏ú‡∏•‡πà‡∏°‡∏≤ (‡∏ñ‡πâ‡∏≤ Inner Join ‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡πÄ‡∏•‡∏¢)
```

### 2.2 SELF JOIN (Join ‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á)
‡πÉ‡∏ä‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏Å‡∏±‡∏ô‡πÄ‡∏≠‡∏á‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß (Hierarchy)
‡πÄ‡∏ä‡πà‡∏ô ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (Employees) ‡∏°‡∏µ‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤ (Manager) ‡∏ã‡∏∂‡πà‡∏á‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡πá‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ñ‡∏ô‡∏ô‡∏∂‡∏á‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ô

```sql
SELECT 
    e.name AS Employee, 
    m.name AS Manager
FROM employees e
INNER JOIN employees m ON e.manager_id = m.id;
```

### 2.3 FULL OUTER JOIN
‡πÄ‡∏≠‡∏≤‡∏´‡∏°‡∏î‡πÄ‡∏•‡∏¢! ‡∏ó‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏π‡πà‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏π‡πà (‡∏£‡∏ß‡∏° Left + Right Join)
*(MySQL ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ô‡∏µ‡πâ‡∏ï‡∏£‡∏á‡πÜ ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ UNION ‡πÅ‡∏ï‡πà PostgreSQL ‡∏°‡∏µ)*

---

## üõ°Ô∏è 3. ACID Transactions

‡∏´‡∏±‡∏ß‡πÉ‡∏à‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÉ‡∏´‡πâ SQL (Relational DB) ‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ö‡∏≠‡∏£‡πå 1 ‡πÉ‡∏ô‡πÇ‡∏•‡∏Å Enterprise ‡∏Ñ‡∏∑‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡πà‡∏≤‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏ñ‡∏∑‡∏≠‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ß‡πà‡∏≤ **ACID**

‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå: **‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô** üí∏
1.  ‡∏ï‡∏±‡∏î‡πÄ‡∏á‡∏¥‡∏ô A - 500 ‡∏ö‡∏≤‡∏ó
2.  (‡πÑ‡∏ü‡∏î‡∏±‡∏ö‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ! üí•)
3.  ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏á‡∏¥‡∏ô B + 500 ‡∏ö‡∏≤‡∏ó

‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ Transaction... ‡πÄ‡∏á‡∏¥‡∏ô A ‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡∏ü‡∏£‡∏µ‡πÜ!
‡πÅ‡∏ï‡πà‡∏ñ‡πâ‡∏≤‡∏°‡∏µ Transaction -> ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞ **Rollback** ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡πÄ‡∏Å‡∏¥‡∏î‡∏≠‡∏∞‡πÑ‡∏£‡∏Ç‡∏∂‡πâ‡∏ô

### ACID Properties
1.  **A - Atomicity** (‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏∞‡∏ï‡∏≠‡∏°): "All or Nothing" ‡∏ñ‡πâ‡∏≤‡∏ó‡∏≥‡πÑ‡∏°‡πà‡∏à‡∏ö ‡∏Å‡πá‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡∏´‡πâ‡∏≤‡∏°‡∏ó‡∏≥‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡πÜ ‡∏Å‡∏•‡∏≤‡∏á‡πÜ
2.  **C - Consistency** (‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á): ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡πâ‡∏≠‡∏á‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏Å‡∏é (Constraints) ‡πÄ‡∏™‡∏°‡∏≠ (‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏á‡∏¥‡∏ô‡∏´‡πâ‡∏≤‡∏°‡∏ï‡∏¥‡∏î‡∏•‡∏ö)
3.  **I - Isolation** (‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏¢‡∏Å‡∏ï‡∏±‡∏ß): Transaction ‡∏Ç‡∏≠‡∏á‡∏ô‡∏≤‡∏¢ A ‡∏Å‡∏±‡∏ö ‡∏ô‡∏≤‡∏¢ B ‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô ‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏ï‡∏µ‡∏Å‡∏±‡∏ô (‡πÄ‡∏ä‡πà‡∏ô ‡πÅ‡∏¢‡πà‡∏á‡∏Å‡∏±‡∏ô‡∏ï‡∏±‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡πâ‡∏≠‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô)
4.  **D - Durability** (‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏á‡∏ó‡∏ô): ‡∏ñ‡πâ‡∏≤ Save Success ‡πÅ‡∏•‡πâ‡∏ß (Commit) ‡∏ï‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÑ‡∏ü‡∏î‡∏±‡∏ö ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡πâ‡∏≠‡∏á‡∏¢‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà (‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Disk ‡πÅ‡∏•‡πâ‡∏ß)

### Implementing Transaction
```sql
BEGIN TRANSACTION; -- ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏î

UPDATE accounts SET balance = balance - 500 WHERE id = 1;

-- ‡∏™‡∏°‡∏°‡∏ï‡∏¥‡πÄ‡∏Å‡∏¥‡∏î Error ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ -> ‡πÄ‡∏£‡∏≤‡∏™‡∏±‡πà‡∏á COMMIT ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ -> ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞ Auto Rollback (‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏£‡∏≤‡∏™‡∏±‡πà‡∏á‡πÄ‡∏≠‡∏á)

UPDATE accounts SET balance = balance + 500 WHERE id = 2;

COMMIT; -- ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏à‡∏£‡∏¥‡∏á (‡∏ñ‡πâ‡∏≤‡∏°‡∏≤‡∏ñ‡∏∂‡∏á‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÅ‡∏õ‡∏•‡∏ß‡πà‡∏≤‡∏ú‡πà‡∏≤‡∏ô‡∏ó‡∏∏‡∏Å‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î)
```

---

## ü™ü 4. Window Functions (The Magic Tool)

‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡∏•‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÉ‡∏´‡πâ SQL ‡∏â‡∏•‡∏≤‡∏î‡∏Ç‡∏∂‡πâ‡∏ô 100%
‡∏õ‡∏Å‡∏ï‡∏¥ `GROUP BY` ‡∏à‡∏∞‡∏¢‡∏∏‡∏ö‡∏£‡∏ß‡∏°‡πÅ‡∏ñ‡∏ß ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÅ‡∏Ñ‡πà‡∏ú‡∏•‡∏£‡∏ß‡∏°... ‡πÅ‡∏ï‡πà `Window Function` ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ú‡∏•‡∏£‡∏ß‡∏° **‡πÇ‡∏î‡∏¢‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡πÅ‡∏ñ‡∏ß‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏ß‡πâ**

### Example: ‡∏≠‡∏¢‡∏≤‡∏Å‡∏£‡∏π‡πâ Agv Salary ‡∏Ç‡∏≠‡∏á‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡∏≠‡∏¢‡∏≤‡∏Å‡πÄ‡∏´‡πá‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏î‡πâ‡∏ß‡∏¢
```sql
SELECT 
    name, 
    salary,
    AVG(salary) OVER() as company_avg_salary,
    salary - AVG(salary) OVER() as diff_from_avg
FROM employees;
```

### Common Window Functions
*   `ROW_NUMBER()`: ‡∏£‡∏±‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà 1, 2, 3... (‡πÉ‡∏ä‡πâ‡∏ó‡∏≥ Pagination ‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏≤ "‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î")
*   `RANK()`: ‡∏à‡∏±‡∏î‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö (‡∏ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà 1 ‡πÄ‡∏™‡∏°‡∏≠‡∏Å‡∏±‡∏ô ‡∏Ñ‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏µ‡πà 3)
*   `LEAD()` / `LAG()`: ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏Ç‡∏≠‡∏á‡πÅ‡∏ñ‡∏ß‡∏ñ‡∏±‡∏î‡πÑ‡∏õ/‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤ (‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Growth Rate: ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß)

---

## üíâ 5. SQL Injection (Security Hazard) üö®

‡∏†‡∏±‡∏¢‡∏£‡πâ‡∏≤‡∏¢‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö 1 ‡∏ï‡∏•‡∏≠‡∏î‡∏Å‡∏≤‡∏•!

### The Vulnerability
```javascript
// ‚ùå Dangerous Code
const query = "SELECT * FROM users WHERE name = '" + req.body.name + "'";

// ‡∏ñ‡πâ‡∏≤ Hacker ‡∏™‡πà‡∏á name ‡∏°‡∏≤‡∏ß‡πà‡∏≤: ' OR '1'='1
// Query ‡∏Å‡∏•‡∏≤‡∏¢‡πÄ‡∏õ‡πá‡∏ô: SELECT * FROM users WHERE name = '' OR '1'='1'
// ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå: Login ‡∏ú‡πà‡∏≤‡∏ô‡∏ó‡∏∏‡∏Å User! (‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏≤‡∏à‡∏™‡∏±‡πà‡∏á DROP TABLE ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢)
```

### The Fix: Prepared Statements
‡πÄ‡∏£‡∏≤‡πÉ‡∏ä‡πâ `?` (Placeholders) ‡πÅ‡∏ó‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠ String
Database ‡∏à‡∏∞‡∏°‡∏≠‡∏á Input ‡πÄ‡∏õ‡πá‡∏ô "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•" ‡πÄ‡∏™‡∏°‡∏≠ ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà "‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á"

```javascript
// ‚úÖ Safe Code (‡πÉ‡∏ä‡πâ library ‡∏≠‡∏¢‡πà‡∏≤‡∏á mysql2 ‡∏´‡∏£‡∏∑‡∏≠ pg)
const query = "SELECT * FROM users WHERE name = ?";
db.execute(query, [req.body.name]);
```

---

## üöÄ 6. Performance Tips & Anti-Patterns

### ‚ùå The "N+1" Problem
‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏¢‡∏≠‡∏î‡∏Æ‡∏¥‡∏ï‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏ä‡πâ ORM ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô Loop
*   **Scenario**: ‡∏≠‡∏¢‡∏≤‡∏Å‡πÅ‡∏™‡∏î‡∏á list ‡∏ö‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏° (10 ‡∏≠‡∏±‡∏ô) ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô
*   **The Bad Way**:
    1.  Query ‡∏ö‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏° 10 ‡∏≠‡∏±‡∏ô (`SELECT * FROM posts LIMIT 10`)
    2.  Loop ‡∏ö‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°... ‡πÅ‡∏•‡πâ‡∏ß Query ‡∏´‡∏≤‡∏Ñ‡∏ô‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡∏•‡∏∞‡∏£‡∏≠‡∏ö (`SELECT * FROM users WHERE id = ?`)
    3.  **Total Queries**: 1 (Get Posts) + 10 (Get User) = **11 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á!** (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ 1000 ‡∏ö‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡πá‡∏ï‡∏≤‡∏¢)
*   **The Good Way (Eager Loading)**:
    1.  Query ‡∏ó‡∏µ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏à‡∏ö‡∏î‡πâ‡∏ß‡∏¢ `JOIN`
    2.  `SELECT posts.*, users.name FROM posts JOIN users ...`

### ‚ùå SELECT * is Evil
*   ‡∏≠‡∏¢‡πà‡∏≤‡∏°‡∏±‡∏Å‡∏á‡πà‡∏≤‡∏¢‡πÉ‡∏ä‡πâ `SELECT *` ‡∏ñ‡πâ‡∏≤ DB ‡∏°‡∏µ 50 column ‡πÅ‡∏ï‡πà‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏ä‡πâ‡πÅ‡∏Ñ‡πà 2
*   ‡∏°‡∏±‡∏ô‡πÄ‡∏õ‡∏•‡∏∑‡∏≠‡∏á Bandwidth, ‡πÄ‡∏õ‡∏•‡∏∑‡∏≠‡∏á RAM Server, ‡πÅ‡∏•‡∏∞‡∏ó‡∏≥‡πÉ‡∏´‡πâ Index ‡∏ö‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ (Covering Index)

---

## ‚ö° Challenge: The Slow Query üïµÔ∏è‚Äç‚ôÇÔ∏è
‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏ï‡∏≤‡∏£‡∏≤‡∏á `orders` ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• 10 ‡∏•‡πâ‡∏≤‡∏ô‡πÅ‡∏ñ‡∏ß
Query ‡∏ô‡∏µ‡πâ‡∏ä‡πâ‡∏≤‡∏°‡∏≤‡∏Å ‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤ 10 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ!

```sql
SELECT * FROM orders WHERE YEAR(created_at) = 2023;
```
*(‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏°‡∏µ Index ‡∏ó‡∏µ‡πà created_at ‡πÅ‡∏•‡πâ‡∏ß‡∏ô‡∏∞! ‡πÅ‡∏ï‡πà‡∏ó‡∏≥‡πÑ‡∏°‡∏¢‡∏±‡∏á‡∏ä‡πâ‡∏≤?)*

::: details ‚ú® ‡πÄ‡∏â‡∏•‡∏¢
**‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏**: ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÄ‡∏£‡∏≤‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô `YEAR()` ‡∏Ñ‡∏£‡∏≠‡∏ö column `created_at`
Database ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ Index ‡πÑ‡∏î‡πâ ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô Index ‡∏Ñ‡∏∑‡∏≠ Date ‡πÄ‡∏ï‡πá‡∏°‡πÜ ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà Year (‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ß‡πà‡∏≤ **Index Scanning** ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥ **Full Table Scan** ‡πÅ‡∏ó‡∏ô)

**‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ**: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô Range
```sql
SELECT * FROM orders 
WHERE created_at >= '2023-01-01' AND created_at <= '2023-12-31';
```
‡πÅ‡∏ö‡∏ö‡∏ô‡∏µ‡πâ Database ‡∏à‡∏∞‡πÉ‡∏ä‡πâ Index ‡∏ß‡∏¥‡πà‡∏á‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô 100 ‡πÄ‡∏ó‡πà‡∏≤! üöÄ
:::

---

## üìö FAQ

**Q: ‡∏à‡∏∞‡∏£‡∏π‡πâ‡πÑ‡∏î‡πâ‡πÑ‡∏á‡∏ß‡πà‡∏≤ Query ‡πÑ‡∏´‡∏ô‡∏ä‡πâ‡∏≤?**
A: ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á `EXPLAIN` ‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤ Query (‡πÄ‡∏ä‡πà‡∏ô `EXPLAIN SELECT ...`) Database ‡∏à‡∏∞‡∏ö‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô (Query Plan) ‡∏ß‡πà‡∏≤‡∏°‡∏±‡∏ô Scan Table ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ Index

**Q: Stored Procedure ‡∏¢‡∏±‡∏á‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏´‡∏°?**
A: ‡∏™‡∏°‡∏±‡∏¢‡πÉ‡∏´‡∏°‡πà‡∏ô‡∏¥‡∏¢‡∏°‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô Logic ‡∏ó‡∏µ‡πà App Server (Node.js) ‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏û‡∏£‡∏≤‡∏∞ Scale ‡∏á‡πà‡∏≤‡∏¢‡∏Å‡∏ß‡πà‡∏≤‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Version Control (Git) ‡∏™‡∏∞‡∏î‡∏ß‡∏Å‡∏Å‡∏ß‡πà‡∏≤ ‡πÅ‡∏ï‡πà Stored Proc ‡∏Å‡πá‡∏¢‡∏±‡∏á‡πÄ‡∏£‡πá‡∏ß‡∏™‡∏∏‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏´‡∏ô‡∏±‡∏Å‡πÜ ‡πÉ‡∏ô DB

---

## üîó References
- [Use The Index, Luke!](https://use-the-index-luke.com/) - ‡∏Ñ‡∏±‡∏°‡∏†‡∏µ‡∏£‡πå‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á Index (‡∏≠‡πà‡∏≤‡∏ô‡πÄ‡∏ñ‡∏≠‡∏∞ ‡∏î‡∏µ‡∏°‡∏≤‡∏Å)
- [PostgreSQL Window Functions](https://www.postgresql.org/docs/current/tutorial-window.html)
- [SQL Anti-patterns Book](https://pragprog.com/titles/bksqla/sql-antipatterns/)

> üëâ **‡∏ö‡∏ó‡∏ï‡πà‡∏≠‡πÑ‡∏õ: [Module 6 Project: Inventory API](/node/06-project-inventory-api)**
